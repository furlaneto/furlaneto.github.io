<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Melhorando a performance de requisições HTTP no RestTemplate utilizando um pool de conexões | techiohub</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Melhorando a performance de requisições HTTP no RestTemplate utilizando um pool de conexões" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Assim como nos bancos de dados, o processo de abrir uma conexão pode ser muito custoso, pois envolver resolução de DNS, abertura de socket, handshake, caso seja uma conexão HTTPS, etc. Deste forma, se manter uma quantidade de conexões abertas e reutilizá-las, sem ter que passar por todo esse processo de abertura de conexão, resultará em um ganho de performance da sua aplicação." />
<meta property="og:description" content="Assim como nos bancos de dados, o processo de abrir uma conexão pode ser muito custoso, pois envolver resolução de DNS, abertura de socket, handshake, caso seja uma conexão HTTPS, etc. Deste forma, se manter uma quantidade de conexões abertas e reutilizá-las, sem ter que passar por todo esse processo de abertura de conexão, resultará em um ganho de performance da sua aplicação." />
<link rel="canonical" href="https://techiohub.com/melhorando-a-performance-de-requisicoes-http-no-resttemplate-utilizando-um-pool-de-conexoes/" />
<meta property="og:url" content="https://techiohub.com/melhorando-a-performance-de-requisicoes-http-no-resttemplate-utilizando-um-pool-de-conexoes/" />
<meta property="og:site_name" content="techiohub" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-01-31T20:49:11-02:00" />
<script type="application/ld+json">
{"description":"Assim como nos bancos de dados, o processo de abrir uma conexão pode ser muito custoso, pois envolver resolução de DNS, abertura de socket, handshake, caso seja uma conexão HTTPS, etc. Deste forma, se manter uma quantidade de conexões abertas e reutilizá-las, sem ter que passar por todo esse processo de abertura de conexão, resultará em um ganho de performance da sua aplicação.","@type":"BlogPosting","url":"https://techiohub.com/melhorando-a-performance-de-requisicoes-http-no-resttemplate-utilizando-um-pool-de-conexoes/","headline":"Melhorando a performance de requisições HTTP no RestTemplate utilizando um pool de conexões","dateModified":"2018-01-31T20:49:11-02:00","datePublished":"2018-01-31T20:49:11-02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://techiohub.com/melhorando-a-performance-de-requisicoes-http-no-resttemplate-utilizando-um-pool-de-conexoes/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://techiohub.com/feed.xml" title="techiohub" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">techiohub</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">Sobre</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Melhorando a performance de requisições HTTP no RestTemplate utilizando um pool de conexões</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-01-31T20:49:11-02:00" itemprop="datePublished">Jan 31, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Assim como nos bancos de dados, o processo de abrir uma conexão pode ser muito custoso, pois envolver resolução de DNS, abertura de <em>socket</em>, <em>handshake</em>, caso seja uma conexão HTTPS, etc. Deste forma, se manter uma quantidade de conexões abertas e reutilizá-las, sem ter que passar por todo esse processo de abertura de conexão, resultará em um ganho de performance da sua aplicação.</p>

<p>Esse processo de manter algumas conexões abertas é chamado de <em>pool</em>, e assim como nos bancos de dados, todos fornecem tal funcionalidade e não é diferente para as linguagens de programação, mas neste exemplo será abordado especificamente o RestTemplate do Spring.</p>

<p>Antes de declarar os @Bean de configuração, é bom saber qual a média de consultas serão realizadas, pois assim, é possível configurar com maior precisão o <em>pool</em>.</p>

<p>Para começar, é necessário declarar os @Bean relacionados a configurações dos <em>requests</em>, HttpClient, RestTemplate e o <em>connection manager</em> do <em>pool</em>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">PoolingHttpClientConnectionManager</span> <span class="nf">poolingHttpClientConnectionManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">PoolingHttpClientConnectionManager</span> <span class="n">connectionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolingHttpClientConnectionManager</span><span class="o">();</span>
    <span class="n">connectionManager</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="n">connectionManager</span><span class="o">.</span><span class="na">setDefaultMaxPerRoute</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">connectionManager</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">RequestConfig</span> <span class="nf">requestConfig</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">RequestConfig</span> <span class="n">requestConfig</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="o">.</span><span class="na">custom</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setConnectionRequestTimeout</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setSocketTimeout</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">requestConfig</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">CloseableHttpClient</span> <span class="nf">httpClient</span><span class="o">(</span><span class="n">PoolingHttpClientConnectionManager</span> <span class="n">poolingHttpClientConnectionManager</span><span class="o">,</span> <span class="n">RequestConfig</span> <span class="n">requestConfig</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">CloseableHttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="n">HttpClientBuilder</span>
        <span class="o">.</span><span class="na">create</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setConnectionManager</span><span class="o">(</span><span class="n">poolingHttpClientConnectionManager</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setDefaultRequestConfig</span><span class="o">(</span><span class="n">requestConfig</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">httpClient</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">RestTemplate</span> <span class="nf">restTemplate</span><span class="o">(</span><span class="n">HttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">HttpComponentsClientHttpRequestFactory</span> <span class="n">requestFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpComponentsClientHttpRequestFactory</span><span class="o">();</span>
    <span class="n">requestFactory</span><span class="o">.</span><span class="na">setHttpClient</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">RestTemplate</span><span class="o">(</span><span class="n">requestFactory</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Na criação do <em>connection manager</em> do <em>pool</em>, é possível ver dois atributos, o <strong>maxTotal</strong> e <strong>defaultMaxPerRoute</strong>. O primeiro trata da quantidade total de conexões que poderão ser abertas no <em>pool</em> e o segundo a quantidade máxima de conexões que poderão ser abertas por rota, que nada mais é os endereços que serão consultados, formados por <strong>protocolo://host:porta</strong>. Neste exemplo foi utilizado 100 conexões abertas por cada roda e no máximo 1000 conexoes abertas no total, sendo assim, podemos ter até 10 rotas com 100 conexões abertas cada que não iria ultrapassar o limite ou também mais rotas, só que cada um com menos conexões abertas, por isso é importante conhecer o consumo antes de realizar a configuração.</p>

<p>Além de configurar um <em>default</em> para a quantidade máxima de conexões por rota, também é possível configurar a quantidade máxima para uma rota em específico. Fazendo da seguinte forma:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">PoolingHttpClientConnectionManager</span> <span class="nf">poolingHttpClientConnectionManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">PoolingHttpClientConnectionManager</span> <span class="n">connectionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolingHttpClientConnectionManager</span><span class="o">();</span>
    <span class="n">connectionManager</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="n">connectionManager</span><span class="o">.</span><span class="na">setDefaultMaxPerRoute</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">HttpHost</span> <span class="n">httpHost</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHost</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8085</span><span class="o">,</span> <span class="s">"http"</span><span class="o">);</span>
    <span class="n">connectionManager</span><span class="o">.</span><span class="na">setMaxPerRoute</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpRoute</span><span class="o">(</span><span class="n">httpHost</span><span class="o">),</span> <span class="mi">200</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">connectionManager</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Assim, terá um <em>default</em> de 100 conexões por rota e especificamente para a rota http://localhost:8085 terá 200.</p>

<p>Esta é uma configuração básica de utilização de um <em>pool</em> de conexões HTTP e para aqueles que queiram saber mais do assunto em questão, pode acessar os links no fim do post.</p>

<p><strong>Links Úteis</strong></p>
<ul>
  <li><a href="https://hc.apache.org/httpcomponents-client-4.2.x/tutorial/html/connmgmt.html">Connection management</a></li>
  <li><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html">RestTemplate</a></li>
</ul>

  </div><a class="u-url" href="/melhorando-a-performance-de-requisicoes-http-no-resttemplate-utilizando-um-pool-de-conexoes/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">techiohub</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">techiohub</li><li><a class="u-email" href="mailto:lucasfurlaneto.s@gmail.com">lucasfurlaneto.s@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Divulgação e troca de conhecimentos relacionados a desenvolvimento,  tecnologia, design, melhores práticas, mundo open source e muito mais.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
